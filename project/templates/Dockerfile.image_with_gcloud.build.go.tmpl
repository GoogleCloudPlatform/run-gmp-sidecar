# NOTE: File generated by distrogen. Do not manually edit.

# This Dockerfile provides the same resulting container as
# the main Dockerfile, but it also performs the build within
# an earlier layer. The resulting container will be scratch and
# should be functionally identical.

ARG PROJECT_ROOT="."
ARG CERT_CONTAINER="debian"
ARG BUILD_CONTAINER="debian"
FROM --platform=${BUILDPLATFORM:-linux/amd64} ${BUILD_CONTAINER} AS build
RUN rm -f /etc/apt/sources.list.d/* /etc/apt/sources.list
RUN echo 'deb https://us-apt.pkg.dev/remote/artifact-foundry-prod/debian-3p-remote-bookworm bookworm main' | tee -a  /etc/apt/sources.list.d/artifact-registry.list
RUN apt-get update && apt-get install -y make curl gettext-base

ARG PROJECT_ROOT
COPY ${PROJECT_ROOT} /

WORKDIR /project/run-gmp-sidecar

ARG BUILDARCH
ARG BUILDOS
ARG TARGETOS
ARG TARGETARCH

RUN make GO_BIN_DIR=/usr/local/go/bin USE_GO_PROXY=https://us-go.pkg.dev/access-aoss/assuredoss-go build

FROM ${CERT_CONTAINER} AS certs
RUN rm -f /etc/apt/sources.list.d/* /etc/apt/sources.list
RUN echo 'deb https://us-apt.pkg.dev/remote/artifact-foundry-prod/debian-3p-remote-bookworm bookworm main' | tee -a  /etc/apt/sources.list.d/artifact-registry.list
RUN apt-get update && apt-get install -y ca-certificates

FROM scratch

ARG USER_UID=10001
USER ${USER_UID}

COPY --from=certs /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

COPY --from=build --chmod=755 /project/run-gmp-sidecar/rungmpcol /rungmpcol
COPY --from=build --chmod=755 /project/run-gmp-sidecar/run-gmp-entrypoint /run-gmp-entrypoint
COPY --from=build --chmod=644 /project/run-gmp-sidecar/config.yaml /etc/rungmpcol/config.yaml

ENTRYPOINT ["/run-gmp-entrypoint"]
CMD ["--config=/etc/rungmpcol/config.yaml"]
